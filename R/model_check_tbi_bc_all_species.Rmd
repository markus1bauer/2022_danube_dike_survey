---
title: "Analysis of Bauer et al. (unpublished) Beta diversity on dike grasslands: <br> Temporal beta-diversity index (TBI). Gains vs. Losses with all species"
author: "<b>Markus Bauer</b> <br>"
date: "<b>`r format(Sys.time(), '%Y-%m-%d')`</b>"
output:
  github_document:
    toc: true
    toc_depth: 3
    dev: png
    fig_width: 7
    fig_height: 5
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE
  )
```

<br/>
<br/>
<b>Markus Bauer</b>

Technichal University of Munich, TUM School of Life Sciences, Chair of
Restoration Ecology, Emil-Ramann-Stra√üe 6, 85354 Freising, Germany

[markus1.bauer\@tum.de](mailto:markus1.bauer@tum.de)

ORCiD ID: [0000-0001-5372-4174](https://orcid.org/0000-0001-5372-4174)
<br>
[Google Scholar](https://scholar.google.de/citations?user=oHhmOkkAAAAJ&hl=de&oi=ao)
<br>
GitHub: [markus1bauer](https://github.com/markus1bauer)

To compare different models, you only have to change the models in
section 'Load models'

# Preparation

Temporal beta-diversity index (TBI) sensu Legendre (2019) Ecol Evol [DOI: 10.1002/ece3.4984](https://doi.org/10.1002/ece3.4984)


#### Packages

```{r libraries, message = FALSE}
library(here)
library(tidyverse)
library(ggbeeswarm)
library(blme)
library(DHARMa)
library(emmeans)
```

```{r echo = FALSE}
rm(list = ls())
```

#### Load data

```{r load-data}
setwd(here("data", "processed"))
sites <- read_csv("data_processed_sites_temporal.csv",
                  col_names = TRUE, na = c("", "na", "NA"),
                  col_types =
                    cols(
                      .default = "?",
                      plot = "f",
                      block = "f",
                      comparison = "f",
                      location = "f",
                      location_construction_year = "f",
                      exposition = col_factor(levels = c("south", "north")),
                      orientation = col_factor(levels = c("land", "water"))
                    )) %>%
  filter(
    (comparison == "1718" | comparison == "1819" | comparison == "1921") &
      pool == "all" & presabu == "presence") %>%
  mutate(
    y = c - b,
    comparison = factor(comparison)
    ) %>%
  mutate(across(
    c("river_km", "river_distance", "biotope_distance", "biotope_area"), scale)
    )
```

# Statistics

## Data exploration (Step 2, 6, 7)

### Graphs of raw data

```{r data-exploration, echo = FALSE}
mean(sites$y)
median(sites$y)
sd(sites$y)
Rmisc::CI(sites$y, ci = .95)
quantile(sites$y, probs = c(0.05, 0.95), na.rm = TRUE)
ggplot(sites, aes(x = comparison, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Comparison of consecutive surveys")
ggplot(sites, aes(x = exposition, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Exposition of dike slopes")
ggplot(sites, aes(x = orientation, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Orientation of dike slopes")
ggplot(sites, aes(x = river_km, y = (y))) +
  geom_point() +  geom_smooth(method = "lm") +
  labs(title = "Position along the river")
ggplot(sites, aes(x = location_construction_year, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Location and construction year of the dike")
ggplot(sites, aes(x = (river_distance), y = (y))) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "Distance to river course")
ggplot(sites, aes(x = (biotope_distance), y = (y))) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "Distance to closest grassland biotope")
ggplot(sites, aes(x = (biotope_area), y = (y))) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "Amount of grassland biotopes with 500 m radius")
ggplot(sites, aes(x = pc1_soil, y = (y))) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "PC1 (soil)")
ggplot(sites, aes(x = (pc2_soil), y = y)) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "PC2 (soil)")
ggplot(sites, aes(x = comparison, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  facet_grid(~exposition) +
  labs(title = "Exposion x Comparison of consecutive surveys")
ggplot(sites, aes(x = pc1_soil, y = y, color = comparison)) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "PC1 x Comparison of consecutive surveys")
ggplot(sites, aes(x = pc2_soil, y = y, color = comparison)) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "PC2 x Comparison of consecutive surveys")
ggplot(sites, aes(x = pc1_soil, y = y, color = exposition)) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "PC1 x Exposition")
ggplot(sites, aes(x = (pc2_soil), y = y, color = exposition)) +
  geom_point() + geom_smooth(method = "lm") +
  labs(title = "PC2 x Exposition")
```

### Outliers, zero-inflation, transformations? (Step 1, 3, 4)

```{r outliers, echo = FALSE}
sites %>%
  count(location_construction_year)
boxplot(sites$n)
ggplot(sites, aes(x = exposition, y = y)) +
  geom_quasirandom()
ggplot(sites, aes(x = y)) +
  geom_histogram(binwidth = 0.03)
ggplot(sites, aes(x = y)) +
  geom_density()
ggplot(sites, aes(x = log(y))) +
  geom_density()
```

### Check collinearity part 1 (Step 5)

Exclude r > 0.7
Dormann et al. 2013 Ecography
https://doi.org/10.1111/j.1600-0587.2012.07348.x

```{r outliers, echo = FALSE}
GGally::ggpairs(
  data_collinearity,
  lower = list(continuous = "smooth_loess"),
  axisLabels = "internal"
  )
```

## Models

### Load models

Only here you have to modify the script to compare other models

```{r load-models, collapse = TRUE}
load(file = here("outputs", "models", "model_fcs_2.Rdata"))
load(file = here("outputs", "models", "model_fcs_full.Rdata"))
load(file = here("outputs", "models", "model_fcs_2_prior.Rdata"))
# BARG 5.A/B/C
load(file = here("outputs", "models", "model_fcs_2_flat.Rdata"))
m_1 <- m2
m_2 <- m_full
m_prior <- m2_prior
m_flat <- m2_flat
```

### Model specifications

```{r formulas, collapse = TRUE}
m_1$formula
m_2$formula
```

```{r families, collapse = TRUE}
m_1$family
m_2$family
```

## Model check

### DHARMa

#### Total model

```{r dharma_all, collapse = TRUE}
simulation_output_1 <- simulateResiduals(m_1, plot = TRUE)
simulation_output_2 <- simulateResiduals(m_2, plot = TRUE)
```

```{r dharma_single, collapse = TRUE}
plotResiduals(simulation_output_1$scaledResiduals,
              sites$location_construction_year)
plotResiduals(simulation_output_1$scaledResiduals, sites$plot)
plotResiduals(simulation_output_2$scaledResiduals, sites$plot)
plotResiduals(simulation_output_1$scaledResiduals, sites$location)
plotResiduals(simulation_output_2$scaledResiduals, sites$location)
plotResiduals(simulation_output_1$scaledResiduals, sites$location_construction_year)
plotResiduals(simulation_output_2$scaledResiduals, sites$location_construction_year)
plotResiduals(simulation_output_1$scaledResiduals, sites$comparison)
plotResiduals(simulation_output_2$scaledResiduals, sites$comparison)
plotResiduals(simulation_output_1$scaledResiduals, sites$exposition)
plotResiduals(simulation_output_2$scaledResiduals, sites$exposition)
plotResiduals(simulation_output_1$scaledResiduals, sites$orientation)
plotResiduals(simulation_output_2$scaledResiduals, sites$orientation)
plotResiduals(simulation_output_1$scaledResiduals, sites$pc1_soil)
plotResiduals(simulation_output_2$scaledResiduals, sites$pc1_soil)
plotResiduals(simulation_output_1$scaledResiduals, sites$pc2_soil)
plotResiduals(simulation_output_2$scaledResiduals, sites$pc2_soil)
plotResiduals(simulation_output_1$scaledResiduals, sites$pc3_soil)
plotResiduals(simulation_output_2$scaledResiduals, sites$pc3_soil)
plotResiduals(simulation_output_1$scaledResiduals, sites$river_km)
plotResiduals(simulation_output_2$scaledResiduals, sites$river_km)
plotResiduals(simulation_output_1$scaledResiduals, sites$river_distance)
plotResiduals(simulation_output_2$scaledResiduals, sites$river_distance)
plotResiduals(simulation_output_1$scaledResiduals, sites$biotope_distance)
plotResiduals(simulation_output_2$scaledResiduals, sites$biotope_distance)
plotResiduals(simulation_output_1$scaledResiduals, sites$biotope_area)
plotResiduals(simulation_output_2$scaledResiduals, sites$biotope_area)
```

### Check collinearity part 2 (Step 5)

Remove river_km: VIF > 3 or > 10
Zuur et al. 2010 Methods Ecol Evol
https://doi.org/10.1111/j.2041-210X.2009.00001.x

```{r outliers, echo = FALSE}
car::vif(m_1)
car::vif(m_2)
```

## Model comparison

### Conditional <i>R</i><sup>2</sup> values

```{r r2, collapse = TRUE}
MuMIn::r.squaredGLMM(m_1)
MuMIn::r.squaredGLMM(m_2)
```

### AICc

Use AICc and not AIC since ratio n/K < 40
Burnahm & Anderson 2002 p. 66
ISBN: 978-0-387-95364-9

```{r aicc, collapse = TRUE}
m_1_aicc <- update(m_1, REML = FALSE)
m_3_aicc <- update(m_2, REML = FALSE)
MuMIn::AICc(m_1_aicc, m_2_aicc) %>%
  arrange(AICc)
```

## Predicted values

### Forest plot

```{r predicted_values, fig.height = 7}
dotwhisker::dwplot(
  list(m_1, m_2),
  show_intercept = FALSE,
  vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2)) +
  theme_classic()
```

### Effect sizes

Effect sizes of chosen model just to get exact values of means etc. if
necessary.

```{r effect-sizes}
(emm <- emmeans(
  m_1,
  revpairwise ~ comparison | exposition,
  type = "response"
  ))
plot(emm, comparison = TRUE)
sjPlot::plot_model(
  m_1,
  terms = c("comparison", "exposition"),
  type = "emm",
  show.data = FALSE
)
```

```{r write-csv, echo = FALSE}
write.csv(draws1, here("outputs", "statistics", "table_fcs.csv"))
```

# Session info

```{r session-info, echo = FALSE}
sessionInfo()
```
